## Table of Contents
- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Warning: Back Up Your Vault](#warning-back-up-your-vault)
- [How the Scripts Work](#how-the-scripts-work)
- [Usage](#usage)
- [Recent Updates](#recent-updates)

# 1Password Duplicate Finder & Cleaner (CLI-Based)

This project contains two Python scripts that help you identify duplicates, clean your data, and apply bulk changes inside a 1Password vault using the official `op` command-line tool.

These tools are designed for:
- People with large or messy vaults accumulated over many years
- Anyone migrating from another password manager
- Users who want safe, auditable bulk cleaning
- Semi-technical users comfortable with the command line
- Privacy-conscious users (all processing happens locally)

Nothing is sent to external servers. All data stays on your machine.

## Script Files
- `op_dedupe_analyse.py` — safely scans your vault, detects duplicates, and generates a CSV.
- `op_dedupe_apply_changes.py` — reads that CSV and applies updates, archives, and deletions.

# Prerequisites

- 1Password CLI installed  
  ```sh
  brew install --cask 1password-cli
  ```
- Signed in via:
  ```sh
  eval $(op signin)
  ```
- Python 3.9+
- Required Python packages:
  ```sh
  pip3 install tqdm python-dateutil
  ```

# ⚠️ Warning: Back Up Your Vault

Before running any script that modifies your vault, **back up your 1Password data**.

Official instructions:  
https://support.1password.com/back-up-1password-data/

Although the “analyse” script is completely safe, the apply script *modifies your vault*. Always confirm your backup beforehand.

# How the Scripts Work

## `op_dedupe_analyse.py` (SAFE — analysis only)

This script:
1. Prompts you to select a vault interactively.
2. Lists all items via `op item list`.
3. Loads items in parallel with a progress bar.
4. Normalises and compares **full URLs**, not just domains.
5. Handles special cases such as:
   - entries with empty URLs  
   - entries whose URL is only a protocol (`http://`, `https://`)
   - localhost entries (uses fallback matching logic)
6. Identifies duplicate clusters using:
   - URL match
   - title + username match
   - title-only match
7. Determines which entry is the *newest* in each cluster.
8. Writes a CSV containing:
   - recommended actions (`KEEP`, `DELETE`, `ARCHIVE`)
   - newest-item flag  
   - a stable duplicate key  
   - title/URL fields suitable for manual editing.

**No changes are made to your vault.**

## `op_dedupe_apply_changes.py` (DANGEROUS — modifies vault)

This script:
1. Reads your `duplicate_report.csv`.
2. Prompts whether to run in dry-run mode.
3. Applies **all row-level actions**:
   - `DELETE` → deletes item via CLI  
   - `ARCHIVE` → archives item via CLI  
   - `KEEP` → does nothing  
4. Also applies **manual edits** you made in the CSV:
   - Title updates  
   - URL updates  
5. Provides a deletion/update progress bar.
6. Prints a summary report.

# Usage

## Step 1 — Analyse your vault
```sh
python3 op_dedupe_analyse.py
```

You will be prompted to choose a vault.

This creates:

```
duplicate_report.csv
```

## Step 2 — Review & edit CSV
Open the file in Excel / Numbers / Google Sheets.

You may:
- Confirm DELETE or ARCHIVE rows
- Fix incorrect titles or URLs
- Leave `is_newest` blank except for the newest item (autogenerated)

## Step 3 — Apply changes
```sh
python3 op_dedupe_apply_changes.py
```

The script asks:

```
Run in dry-run mode? [Y/n]:
```

Press **Enter** for safe mode, or **n** to proceed with real changes.

# Recent Updates

### Core Improvements
- Added **interactive vault selection**.
- Added **ARCHIVE** support in the apply script.
- Apply script now **reads and applies manual CSV edits** (titles, URLs).
- Added propagation of **titles** from the item being deleted to the one being kept when appropriate.
- Full URL matching (not just domain).
- Improved `url_or_title_key` logic so it never uses `http://` or `https://` as the key.
- Updated `is_newest` to leave non-newest entries blank rather than using “NO”.
- Localhost entries handled via fallback heuristics.

### File Naming (Variant 1)
- `op_dedupe_analyse.py` — safe analysis/report
- `op_dedupe_apply_changes.py` — performs updates/deletes/archives

### Documentation
- Added vault backup warning with official 1Password link.
- Updated README to reflect new logic and naming.

---
MIT License
